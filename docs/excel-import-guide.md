# Excel 批量导入功能使用指南

## 概述

Excel 批量导入功能允许用户通过 CSV 文件批量导入销售预测和实际销量数据,大幅提升数据录入效率。

## 功能特点

1. **灵活的格式支持**: 支持逗号、制表符、分号分隔的 CSV 文件
2. **智能数据验证**:
   - 自动验证周次格式 (YYYY-WNN)
   - 验证 SKU 和渠道代码是否存在
   - 验证数量字段的有效性
3. **数据预览**: 导入前可预览解析后的数据
4. **错误提示**: 详细显示格式错误和数据问题
5. **批量处理**: 一次可导入大量记录

## 使用步骤

### 1. 准备 CSV 文件

#### 必需列 (可以任意顺序):
- `week_iso` - ISO 周次格式 (例: 2025-W49)
- `sku` - 产品 SKU 编码
- `channel_code` - 渠道代码
- `qty` - 数量 (预测数量或实际销量)

#### 文件示例:

```csv
week_iso,sku,channel_code,qty
2025-W49,SKU-001,AMZ-US,100
2025-W49,SKU-001,SHOP-US,50
2025-W49,SKU-002,AMZ-US,75
```

或者使用制表符分隔 (TSV):

```
week_iso	sku	channel_code	qty
2025-W49	SKU-001	AMZ-US	100
2025-W49	SKU-001	SHOP-US	50
```

### 2. 打开导入对话框

1. 进入 **计划管理** > **销量预测管理** 或 **实际销量录入** 页面
2. 选择目标周次
3. 点击 "批量导入" 卡片中的 **"Excel 批量导入"** 按钮

### 3. 下载模板 (可选)

- 点击对话框中的 **"下载模板"** 按钮
- 系统会生成包含示例数据的 CSV 模板
- 在模板基础上修改或填充数据

### 4. 上传文件

1. 点击 **"选择 CSV/Excel 文件"** 按钮
2. 选择准备好的 CSV 文件
3. 系统会自动解析并验证数据

### 5. 检查验证结果

#### 如果有错误:
- 红色错误框会显示所有验证问题
- 包括错误行号、字段名称和错误描述
- 修正文件后重新上传

#### 如果验证通过:
- 数据预览表格显示解析后的记录
- 可查看前 50 条记录
- 显示总记录数

### 6. 确认导入

1. 检查数据预览确认无误
2. 点击 **"确认导入"** 按钮
3. 等待导入完成
4. 成功后自动关闭对话框并刷新页面数据

## 数据验证规则

### 周次格式 (week_iso)
- 格式: `YYYY-WNN` (例: 2025-W49)
- 年份: 4 位数字
- 周次: 01-53 之间的两位数字
- 错误示例: `2025-W99`, `25-W10`, `2025W49`

### SKU
- 必须在系统中存在
- 区分大小写
- 空值会报错

### 渠道代码 (channel_code)
- 必须在系统中存在
- 区分大小写
- 空值会报错

### 数量 (qty)
- 必须是非负整数
- 不能为空
- 非数字会被转换为 0 并报错

## 导入行为

- **去重策略**: 使用 `UPSERT` 操作
  - 唯一键: `week_iso + sku + channel_code`
  - 如果记录已存在,更新数量
  - 如果记录不存在,插入新记录

- **周期日期**: 系统自动计算
  - `week_start_date`: 周一日期
  - `week_end_date`: 周日日期

## 常见问题

### Q: 支持 Excel (.xlsx) 文件吗?
A: 目前仅支持 CSV/TSV 文本格式。可以在 Excel 中 "另存为 CSV" 导出。

### Q: 导入会覆盖现有数据吗?
A: 是的。相同 week_iso + sku + channel_code 的记录会被更新。

### Q: 可以导入多个周次的数据吗?
A: 可以。CSV 文件中可以包含不同周次的数据。

### Q: 表头列名必须完全匹配吗?
A: 不需要。系统会智能识别包含关键词的列名 (如 "week", "sku", "channel", "qty")。

### Q: 文件大小有限制吗?
A: 建议单次导入不超过 1000 条记录,以确保性能。

## 技术实现

- **前端解析**: 使用纯 JavaScript 解析 CSV,无需后端上传
- **批量操作**: 使用 Server Actions 的批量 upsert
- **类型安全**: 完全类型化的 TypeScript 实现
- **数据验证**: Zod schema 验证

## 文件位置

- 组件: `/src/components/planning/excel-import-dialog.tsx`
- Server Actions: `/src/lib/actions/planning.ts`
- 使用页面:
  - `/src/app/planning/forecasts/page.tsx` (销量预测)
  - `/src/app/planning/actuals/page.tsx` (实际销量)
